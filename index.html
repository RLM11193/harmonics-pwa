<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gann Master Wheel</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000" />
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: radial-gradient(circle at center, #111, #000);
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
}
header {
  padding: 10px;
  text-align: center;
}
button {
  background: #222;
  color: #fff;
  border: 1px solid #555;
  padding: 8px 12px;
  margin: 4px;
  border-radius: 6px;
  font-size: 14px;
}
button:hover {
  background: #333;
}
input, select {
  padding: 6px;
  border-radius: 4px;
  border: 1px solid #555;
  background: #111;
  color: #fff;
}
.card {
  background: #111;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(255,255,255,0.05);
  margin: 10px;
}
.wheel-card canvas {
  width: 100%;
  max-width: 560px;
  aspect-ratio: 1/1;
  height: auto;
}
#fs {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
#fs canvas {
  width: 90vw;
  max-width: 90vw;
  aspect-ratio: 1/1;
  height: auto;
}
#helpOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  color: #fff;
  padding: 20px;
  display: none;
  z-index: 10;
}
#helpOverlay h2 {
  margin-top: 0;
}
.glow {
  filter: drop-shadow(0 0 8px yellow);
}
.passPulse {
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 10px lime; }
  50% { box-shadow: 0 0 20px lime; }
}
</style>
</head>
<body>
<header>
  <h1>Gann Master Wheel</h1>
</header>

<div class="card wheel-card" style="position:relative">
  <canvas id="wheel"></canvas>
  <div id="overlayText" style="position:absolute;top:10px;left:10px;font-size:14px;"></div>
</div>

<div>
  <button id="scanBtn">Scan & Calculate</button>
  <button id="teachBtn">Teaching Mode</button>
</div>

<div id="status"></div>
<div id="targets"></div>

<div id="fs">
  <canvas id="fsWheel"></canvas>
  <div id="fsOverlay" style="margin-top:10px;"></div>
  <button id="fsClose">Close</button>
  <button id="helpBtn">?</button>
</div>

<div id="helpOverlay">
  <h2>How to Use</h2>
  <ul>
    <li><b>Glow:</b> Price angle aligns with planet's vibration</li>
    <li><b>PASS:</b> Price & time both align (square-out)</li>
    <li><b>Spin:</b> Drag wheel to find alignments</li>
    <li>Targets update instantly on hit</li>
  </ul>
  <button id="closeHelp">Got it</button>
</div>

<script>
// State
const state = { rot: 0, priceTol: 3, timeTol: 3, planets: {}, hits: [] };

// Helpers
function $(id){ return document.getElementById(id); }
function angDiff(a,b){ return Math.abs(((a-b+180)%360)-180); }
function sizeCanvas(c, px){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  c.width = Math.round(px * dpr);
  c.height = Math.round(px * dpr);
  c.style.width = px + 'px';
  c.style.height = px + 'px';
}

// Draw wheel
function drawWheel(c, { rot, planets, pAngle, tAngle, align }){
  const ctx = c.getContext('2d');
  const r = c.width/2;
  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.translate(r,r);
  ctx.rotate(rot*Math.PI/180);
  ctx.strokeStyle = '#666';
  for(let i=0;i<360;i+=30){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(r*Math.cos(i*Math.PI/180), r*Math.sin(i*Math.PI/180));
    ctx.stroke();
  }
  // planets
  if(planets){
    for(const [nm,deg] of Object.entries(planets)){
      const hit = align.hits.includes(nm);
      ctx.beginPath();
      ctx.arc(r*0.9*Math.cos(deg*Math.PI/180), r*0.9*Math.sin(deg*Math.PI/180), hit?6:4, 0, Math.PI*2);
      ctx.fillStyle = hit ? 'yellow' : '#0ff';
      ctx.fill();
    }
  }
  ctx.restore();
}

// Fake scan for demo (replace with your ephemeris logic)
function doScan(){
  // Example: price angle 45, time angle 90, planets at random
  state.pAngle = 45;
  state.tAngle = 90;
  state.planets = { Sun: 42, Moon: 190, Mars: 88 };
  state.hits = [];
  for(const [nm,deg] of Object.entries(state.planets)){
    if(angDiff(state.pAngle, deg) <= state.priceTol) state.hits.push(nm);
  }
  const pricePass = state.hits.length>0;
  const timePass = angDiff(state.tAngle, 90) <= state.timeTol; // Example logic
  const pass = pricePass && timePass;
  $('status').textContent = pass ? 'PASS' : 'FAIL';
  $('status').className = pass ? 'passPulse' : '';
  $('targets').innerHTML = state.hits.map(nm=>`${nm}: Price ${state.pAngle+100}, Time ${state.tAngle+10}`).join('<br>');
  render();
}

function render(){
  drawWheel($('wheel'), { rot: state.rot, planets: state.planets, pAngle: state.pAngle||0, tAngle: state.tAngle||0, align: { pass: $('status').textContent==='PASS', hits: state.hits || [] } });
}
function renderFS(){
  drawWheel($('fsWheel'), { rot: state.rot, planets: state.planets, pAngle: state.pAngle||0, tAngle: state.tAngle||0, align: { pass: $('status').textContent==='PASS', hits: state.hits || [] } });
  $('fsOverlay').textContent = $('targets').innerHTML;
}

// Spin interaction
let spinning = false, lastY = 0;
$('fsWheel').addEventListener('touchstart', e=>{
  spinning = true;
  lastY = e.touches[0].clientY;
});
$('fsWheel').addEventListener('touchmove', e=>{
  if(spinning){
    const dy = e.touches[0].clientY - lastY;
    lastY = e.touches[0].clientY;
    state.rot += dy * 0.5;
    renderFS();
    // Update live hits
    doScan();
  }
});
$('fsWheel').addEventListener('touchend', ()=> spinning=false);

// Buttons
$('scanBtn').onclick = doScan;
$('teachBtn').onclick = ()=> { $('fs').style.display='flex'; renderFS(); };
$('fsClose').onclick = ()=> { $('fs').style.display='none'; };
$('helpBtn').onclick = ()=> { $('helpOverlay').style.display='block'; };
$('closeHelp').onclick = ()=> { $('helpOverlay').style.display='none'; };

// Init sizing
function resizeCanvases(){
  const pad = 24;
  const wheelPx = Math.min(window.innerWidth - pad*2, 560);
  sizeCanvas($('wheel'), wheelPx);
  const fsPx = Math.min(window.innerWidth, window.innerHeight) - 24;
  sizeCanvas($('fsWheel'), Math.max(240, fsPx));
  render();
}
window.addEventListener('resize', resizeCanvases);
resizeCanvases();
</script>

<script>
// PWA service worker registration
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered'));
}
</script>
</body>
</html>